<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>FutureImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Javaslang</a> &gt; <a href="index.source.html" class="el_package">javaslang.concurrent</a> &gt; <span class="el_source">FutureImpl.java</span></div><h1>FutureImpl.java</h1><pre class="source lang-java linenums">/*     / \____  _    _  ____   ______  / \ ____  __    _ _____
 *    /  /    \/ \  / \/    \ /  /\__\/  //    \/  \  / /  _  \   Javaslang
 *  _/  /  /\  \  \/  /  /\  \\__\\  \  //  /\  \ /\\/  \__/  /   Copyright 2014-now Daniel Dietrich
 * /___/\_/  \_/\____/\_/  \_/\__\/__/___\_/  \_//  \__/_____/    Licensed under the Apache License, Version 2.0
 */
package javaslang.concurrent;

import javaslang.collection.Queue;
import javaslang.control.*;

import java.util.Objects;
import java.util.concurrent.CancellationException;
import java.util.concurrent.ExecutorService;
import java.util.function.Consumer;

/**
 * &lt;strong&gt;INTERNAL API - This class is subject to change.&lt;/strong&gt;
 *
 * {@link Future} implementation, for internal use only.
 * &lt;p&gt;
 * &lt;strong&gt;Lifecycle of a {@code FutureImpl}:&lt;/strong&gt;
 * &lt;p&gt;
 * 1) Creation
 * &lt;ul&gt;
 * &lt;li&gt;{@code value = None}&lt;/li&gt;
 * &lt;li&gt;{@code actions = Queue.empty()}&lt;/li&gt;
 * &lt;li&gt;{@code job = null}&lt;/li&gt;
 * &lt;/ul&gt;
 * 2) Run
 * &lt;ul&gt;
 * &lt;li&gt;{@code value = None}&lt;/li&gt;
 * &lt;li&gt;{@code actions = Queue(...)}&lt;/li&gt;
 * &lt;li&gt;{@code job = java.util.concurrent.Future}&lt;/li&gt;
 * &lt;/ul&gt;
 * 3) Complete
 * &lt;ul&gt;
 * &lt;li&gt;{@code value = Some(Try)}&lt;/li&gt;
 * &lt;li&gt;{@code actions = null}&lt;/li&gt;
 * &lt;li&gt;{@code job = null}&lt;/li&gt;
 * &lt;/ul&gt;
 * 4) Cancel
 * &lt;ul&gt;
 * &lt;li&gt;{@code value = Some(Failure(CancellationException))}&lt;/li&gt;
 * &lt;li&gt;{@code actions = null}&lt;/li&gt;
 * &lt;li&gt;{@code job = null}&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * @param &lt;T&gt; Result of the computation.
 * @author Daniel Dietrich
 * @since 2.0.0
 */
final class FutureImpl&lt;T&gt; implements Future&lt;T&gt; {

    /**
     * Used to start new threads.
     */
    private final ExecutorService executorService;

    /**
     * Used to synchronize state changes.
     */
<span class="fc" id="L62">    private final Object lock = new Object();</span>

    /**
     * Once the Future is completed, the value is defined.
     *
     * @@GuardedBy(&quot;lock&quot;)
     */
<span class="fc" id="L69">    private volatile Option&lt;Try&lt;T&gt;&gt; value = Option.none();</span>

    /**
     * The queue of actions is filled when calling onComplete() before the Future is completed or cancelled.
     * Otherwise actions = null.
     *
     * @@GuardedBy(&quot;lock&quot;)
     */
<span class="fc" id="L77">    private Queue&lt;Consumer&lt;? super Try&lt;T&gt;&gt;&gt; actions = Queue.empty();</span>

    /**
     * Once a computation is started via run(), job is defined and used to control the lifecycle of the computation.
     *
     * @@GuardedBy(&quot;lock&quot;)
     */
<span class="fc" id="L84">    private java.util.concurrent.Future&lt;Try&lt;T&gt;&gt; job = null;</span>

    /**
     * Creates a Future, {@link #run(Try.CheckedSupplier)} has to be called separately.
     *
     * @param executorService An {@link ExecutorService} to run and control the computation and to perform the actions.
     */
<span class="fc" id="L91">    FutureImpl(ExecutorService executorService) {</span>
<span class="fc" id="L92">        Objects.requireNonNull(executorService, &quot;executorService is null&quot;);</span>
<span class="fc" id="L93">        this.executorService = executorService;</span>
<span class="fc" id="L94">    }</span>

    @Override
    public void await() {
<span class="fc" id="L98">        final Object monitor = new Object();</span>
<span class="fc" id="L99">        onComplete(ignored -&gt; {</span>
<span class="fc" id="L100">            synchronized (monitor) {</span>
<span class="fc" id="L101">                monitor.notify();</span>
<span class="pc" id="L102">            }</span>
<span class="fc" id="L103">        });</span>
<span class="fc" id="L104">        synchronized (monitor) {</span>
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">            if (!isCompleted()) {</span>
<span class="fc" id="L106">                Try.run(monitor::wait);</span>
            }
<span class="pc" id="L108">        }</span>
<span class="fc" id="L109">    }</span>

    @Override
    public boolean cancel(boolean mayInterruptIfRunning) {
<span class="fc" id="L113">        synchronized (lock) {</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">            if (isCompleted()) {</span>
<span class="fc" id="L115">                return false;</span>
            } else {
<span class="pc bpc" id="L117" title="2 of 4 branches missed.">                return Try.of(() -&gt; job == null || job.cancel(mayInterruptIfRunning)).onSuccess(cancelled -&gt; {</span>
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">                    if (cancelled) {</span>
<span class="fc" id="L119">                        value = Option.some(Try.failure(new CancellationException()));</span>
<span class="fc" id="L120">                        actions = null;</span>
<span class="fc" id="L121">                        job = null;</span>
                    }
<span class="fc" id="L123">                }).orElse(false);</span>
            }
<span class="nc" id="L125">        }</span>
    }

    @Override
    public ExecutorService executorService() {
<span class="fc" id="L130">        return executorService;</span>
    }

    @Override
    public Option&lt;Try&lt;T&gt;&gt; getValue() {
<span class="fc" id="L135">        return value;</span>
    }

    @Override
    public boolean isCompleted() {
<span class="fc" id="L140">        return value.isDefined();</span>
    }

    @Override
    public void onComplete(Consumer&lt;? super Try&lt;T&gt;&gt; action) {
<span class="fc" id="L145">        Objects.requireNonNull(action, &quot;action is null&quot;);</span>
<span class="fc bfc" id="L146" title="All 2 branches covered.">        if (isCompleted()) {</span>
<span class="fc" id="L147">            perform(action);</span>
        } else {
<span class="fc" id="L149">            synchronized (lock) {</span>
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">                if (isCompleted()) {</span>
<span class="nc" id="L151">                    perform(action);</span>
                } else {
<span class="fc" id="L153">                    actions = actions.enqueue(action);</span>
                }
<span class="pc" id="L155">            }</span>
        }
<span class="fc" id="L157">    }</span>

    /**
     * Runs a computation using the underlying ExecutorService.
     * &lt;p&gt;
     * DEV-NOTE: Internally this method is called by the static {@code Future} factory methods.
     *
     * @throws IllegalStateException if the Future is pending, completed or cancelled
     * @throws NullPointerException  if {@code computation} is null.
     */
    void run(Try.CheckedSupplier&lt;? extends T&gt; computation) {
<span class="fc" id="L168">        Objects.requireNonNull(computation, &quot;computation is null&quot;);</span>
<span class="fc" id="L169">        synchronized (lock) {</span>
<span class="pc bpc" id="L170" title="1 of 2 branches missed.">            if (job != null) {</span>
<span class="nc" id="L171">                throw new IllegalStateException(&quot;The Future is already running.&quot;);</span>
            }
<span class="pc bpc" id="L173" title="1 of 2 branches missed.">            if (isCompleted()) {</span>
<span class="nc" id="L174">                throw new IllegalStateException(&quot;The Future is completed.&quot;);</span>
            }
            // The current lock ensures that the job is assigned before the computation completes,
            // if the ExecutorService runs the computation in a different thread.
            // If the ExecutorService runs the computation in the current thread, the job is already finished and
            // we must not overwrite the state variable 'job', which must remain null.
<span class="fc" id="L180">            final java.util.concurrent.Future&lt;Try&lt;T&gt;&gt; tmpJob = executorService.submit(() -&gt; complete(Try.of(computation)));</span>
<span class="fc bfc" id="L181" title="All 2 branches covered.">            if (!isCompleted()) {</span>
<span class="fc" id="L182">                job = tmpJob;</span>
            }
<span class="pc" id="L184">        }</span>
<span class="fc" id="L185">    }</span>

    /**
     * Completes this Future with a value.
     * &lt;p&gt;
     * DEV-NOTE: Internally this method is called by the {@code Future.run()} method and by {@code Promise}.
     *
     * @param value A Success containing a result or a Failure containing an Exception.
     * @return The given {@code value} for convenience purpose.
     * @throws IllegalStateException if the Future is already completed or cancelled.
     * @throws NullPointerException  if the given {@code value} is null.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    Try&lt;T&gt; complete(Try&lt;? extends T&gt; value) {
<span class="fc" id="L199">        Objects.requireNonNull(value, &quot;value is null&quot;);</span>
        final Queue&lt;Consumer&lt;? super Try&lt;T&gt;&gt;&gt; actions;
        // it is essential to make the completed state public *before* performing the actions
<span class="fc" id="L202">        synchronized (lock) {</span>
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">            if (isCompleted()) {</span>
<span class="nc" id="L204">                throw new IllegalStateException(&quot;The Future is completed.&quot;);</span>
            }
<span class="fc" id="L206">            actions = this.actions;</span>
<span class="fc" id="L207">            this.value = Option.some((Try&lt;T&gt;) value);</span>
<span class="fc" id="L208">            this.actions = null;</span>
<span class="fc" id="L209">            this.job = null;</span>
<span class="pc" id="L210">        }</span>
<span class="fc" id="L211">        actions.forEach(this::perform);</span>
<span class="fc" id="L212">        return (Try&lt;T&gt;) value;</span>
    }

    boolean tryComplete(Try&lt;? extends T&gt; value) {
<span class="fc" id="L216">        Objects.requireNonNull(value, &quot;value is null&quot;);</span>
<span class="fc" id="L217">        synchronized (lock) {</span>
<span class="fc bfc" id="L218" title="All 2 branches covered.">            if (isCompleted()) {</span>
<span class="fc" id="L219">                return false;</span>
            } else {
<span class="fc" id="L221">                complete(value);</span>
<span class="fc" id="L222">                return true;</span>
            }
<span class="nc" id="L224">        }</span>
    }

    private void perform(Consumer&lt;? super Try&lt;T&gt;&gt; action) {
<span class="fc" id="L228">        Try.run(() -&gt; executorService.execute(() -&gt; action.accept(value.get())));</span>
<span class="fc" id="L229">    }</span>

    // This class is MUTABLE and therefore CANNOT CHANGE DEFAULT equals() and hashCode() behavior.
    // See http://stackoverflow.com/questions/4718009/mutable-objects-and-hashcode

    @Override
    public String toString() {
<span class="nc" id="L236">        return stringPrefix() + &quot;(&quot; + value.map(String::valueOf).orElse(&quot;?&quot;) + &quot;)&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>